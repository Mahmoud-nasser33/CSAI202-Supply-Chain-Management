@page
@model SupplyChain.Frontend.Pages.ProductsModel
@{
    ViewData["Title"] = "Products";
}

<div class="container-bento py-4">

    <div class="d-flex justify-content-between align-items-center mb-4 animate-enter">
        <div>
            <h2 class="fw-bold mb-0" id="productsPageTitle">Product Inventory</h2>
            <p class="text-muted mb-0" id="productsPageDesc">Manage catalog and stock levels</p>
        </div>
        <div class="role-admin-only">
            <a href="/CreateProduct" class="btn btn-success btn-lg shadow-sm">
                <i class="bi bi-plus-lg me-2"></i> Register Inventory Item
            </a>
        </div>
    </div>

    <div class="bento-grid mb-4">

        <div class="card border-0 shadow-sm glass-panel bg-gradient-purple text-white animate-enter delay-1 span-col-2" style="background: linear-gradient(rgba(139, 92, 246, 0.8), rgba(109, 40, 217, 0.9)), url('/images/product-parts.png') center/cover !important;">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-container-circle bg-white bg-opacity-25 me-3">
                         <i class="bi bi-tags fs-4 text-white"></i>
                    </div>
                     <h5 class="card-title text-white text-opacity-75 mb-0">Categories</h5>
                </div>
                <h2 class="display-4 fw-bold mb-0">@Model.CategoryCount</h2>
                <p class="card-text text-white text-opacity-75">Diversified Portfolio</p>
            </div>
        </div>

        <div class="card border-0 shadow-sm glass-panel animate-enter delay-2">
             <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-container-circle bg-warning bg-opacity-10 text-warning me-2" style="width: 40px; height: 40px;">
                        <i class="bi bi-star-fill fs-6"></i>
                    </div>
                    <h6 class="fw-bold text-muted mb-0">Top Performer</h6>
                </div>
                <h3 class="fw-bold text-dark">@(Model.Products?.FirstOrDefault()?.Name ?? "No Products")</h3>
                <span class="badge bg-success bg-opacity-10 text-success border border-success">Top Seller</span>
            </div>
        </div>

        <div class="card border-0 shadow-sm glass-panel animate-enter delay-3">
             <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                    <div class="icon-container-circle bg-primary bg-opacity-10 text-primary me-2" style="width: 40px; height: 40px;">
                        <i class="bi bi-hdd-network fs-6"></i>
                    </div>
                    <h6 class="fw-bold text-muted mb-0">Network</h6>
                </div>
                <h3 class="fw-bold text-dark">@Model.SupplierCount Partners</h3>
                <small class="text-muted">Global sourcing active</small>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm glass-panel animate-enter delay-4">
        <div class="card-header bg-transparent border-bottom-0 px-0">
             <h4 class="fw-bold mb-0">Catalog Items</h4>
        </div>
        <div class="card-body px-0 py-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 ps-4">Product Name</th>
                            <th class="py-3">Category</th>
                            <th class="py-3">Supplier</th>
                            <th class="py-3">Price</th>
                            <th class="py-3">Stock Status</th>
                            <th class="py-3 text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Products != null && Model.Products.Count > 0)
                        {
                            @foreach (var item in Model.Products)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-light rounded p-2 me-3 text-primary">
                                                <i class="bi bi-box-seam fs-5"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0 fw-bold text-dark">@item.Name</h6>
                                                <small class="text-muted">SKU: @item.SKU</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-white text-dark border shadow-sm">@item.Category</span></td>
                                    <td class="text-secondary"><i class="bi bi-building me-1"></i> @item.Supplier</td>
                                    <td class="fw-bold text-dark">$@item.Price.ToString("N2")</td>
                                    <td>
                                        @if (item.StockQuantity < 10)
                                        {
                                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3">
                                                <i class="bi bi-exclamation-circle me-1"></i> Low: @item.StockQuantity
                                            </span>
                                        }
                                        else
                                        {
                                            <div class="d-flex align-items-center">
                                                <div class="progress" style="height: 6px; width: 60px; margin-right: 10px;">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: 80%"></div>
                                                </div>
                                                <span class="text-success fw-bold small">@item.StockQuantity</span>
                                            </div>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="role-admin-only">
                                            <a asp-page="/EditProduct" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary me-1">
                                                <i class="bi bi-pencil-fill"></i>
                                            </a>
                                            <form method="post" asp-page-handler="Delete" asp-route-id="@item.Id" class="d-inline"
                                                  >
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash-fill"></i>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="role-customer-only">
                                            <button class="btn btn-sm btn-primary px-3 rounded-pill" onclick="notificationManager.showToast('Item added to cart!', 'success')">
                                                <i class="bi bi-cart-plus me-1"></i> Add to Cart
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                    No products found in the catalog.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const user = sessionManager.getCurrentUser();
        if (!user) return;

        const title = document.getElementById('productsPageTitle');
        const desc = document.getElementById('productsPageDesc');
        const adminOnly = document.querySelectorAll('.role-admin-only');
        const customerOnly = document.querySelectorAll('.role-customer-only');

        if (user.role === 'customer') {
            if (title) title.textContent = 'Digital Product Catalog';
            if (desc) desc.textContent = 'Explore our latest stocks and order items directly.';
            adminOnly.forEach(el => el.style.display = 'none');
            customerOnly.forEach(el => el.style.display = 'block');
        } else if (user.role === 'admin') {
            adminOnly.forEach(el => el.style.display = 'block');
            customerOnly.forEach(el => el.style.display = 'none');
        } else {
            // Staff / Supplier - View Only
            adminOnly.forEach(el => el.style.display = 'none');
            customerOnly.forEach(el => el.style.display = 'none');
        }
    });

</script>