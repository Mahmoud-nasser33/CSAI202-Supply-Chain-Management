@page
@model SupplyChain.Frontend.Pages.AnalyticsModel
@{
    ViewData["Title"] = "Analytics";
}

<div class="container-bento py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-end mb-5 animate-enter">
        <div>
             <span class="badge bg-indigo text-white mb-2 px-3 py-2 rounded-pill border border-white border-opacity-25 shadow-sm" style="background-color: #6366f1;">
                <i class="bi bi-stars"></i> AI Analysis Ready
            </span>
            <h1 class="display-4 fw-bold mb-0">Executive Insights</h1>
            <p class="text-muted lead mb-0">Real-time predictive performance modeling.</p>
        </div>
        <div>
            <button class="btn btn-outline-dark me-2 shadow-sm"><i class="bi bi-calendar-range"></i> This Quarter</button>
            <button class="btn btn-primary shadow-sm"><i class="bi bi-cloud-download"></i> Smart Report</button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="bento-grid mb-5">
        <!-- Revenue Card (Span 2) -->
        <div class="card border-0 shadow-lg glass-panel text-white span-col-2 animate-enter delay-1 overflow-hidden" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;">
             <div class="card-body position-relative p-4">
                 <div class="position-absolute top-0 end-0 p-4 opacity-10">
                    <i class="bi bi-currency-dollar" style="font-size: 8rem;"></i>
                </div>
                <h6 class="text-uppercase fw-bold opacity-75 letter-spacing-1 mb-3">Total Efficiency Revenue</h6>
                <h2 class="display-3 fw-bold mb-0">$1.25M</h2>
                <div class="mt-4 d-flex align-items-center">
                    <span class="badge bg-white text-success rounded-pill px-3 py-2 me-3 fs-6"><i class="bi bi-graph-up-arrow"></i> +18.4%</span>
                    <span class="opacity-75">vs last month prediction</span>
                </div>
            </div>
        </div>

        <!-- Market Share (Span 1) -->
        <div class="card border-0 shadow-sm glass-panel bg-dark text-white animate-enter delay-2 h-100">
             <div class="card-body p-4 d-flex flex-column justify-content-between">
                <div class="d-flex justify-content-between align-items-start">
                    <h6 class="text-uppercase fw-bold opacity-50">Market Dominance</h6>
                    <i class="bi bi-pie-chart-fill text-info fs-4"></i>
                </div>
                <div>
                    <h2 class="display-5 fw-bold mb-2">34.2%</h2>
                    <div class="progress bg-secondary bg-opacity-25 mb-2" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 34.2%"></div>
                    </div>
                    <p class="small text-muted mb-0">Top competitor at 21%.</p>
                </div>
             </div>
        </div>

        <!-- AI Prediction (Span 1) -->
        <div class="card border-0 shadow-sm glass-panel text-white animate-enter delay-3 h-100" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%) !important;">
             <div class="card-body p-4 d-flex flex-column justify-content-between">
                 <h6 class="text-uppercase fw-bold opacity-75"><i class="bi bi-robot me-1"></i> AI Churn Risk</h6>
                 <div>
                     <div class="d-flex align-items-end mb-2">
                         <h2 class="display-5 fw-bold mb-0">Low</h2>
                         <span class="ms-2 fs-5 opacity-50">(2.1%)</span>
                     </div>
                     <p class="small opacity-75 lh-sm mb-0">Suggestion: Add "Loyalty Tier" for retention.</p>
                 </div>
             </div>
        </div>

        <!-- Main Chart (Span 3) -->
        <div class="card shadow-sm border-0 glass-panel span-col-3 animate-enter delay-4">
             <div class="card-body p-4">
                 <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="fw-bold mb-0">Performance Matrix</h4>
                        <small class="text-muted">Multi-variable linear regression model</small>
                    </div>
                     <select class="form-select w-auto border-0 bg-light fw-bold text-secondary">
                        <option>Projection: Q1 2026</option>
                    </select>
                 </div>
                 <div style="height: 400px; width: 100%;">
                    <canvas id="complexChart"></canvas>
                 </div>
             </div>
        </div>

        <!-- Insights Panel (Span 1) -->
        <div class="card shadow-sm border-0 glass-panel bg-light animate-enter delay-5">
             <div class="card-body p-4">
                 <h5 class="fw-bold mb-4">Recommendations</h5>
                 
                 <div class="d-flex mb-4">
                     <div class="flex-shrink-0">
                         <div class="rounded-circle bg-white shadow-sm p-3 d-flex align-items-center justify-content-center text-primary" style="width:45px; height:45px;">
                             <i class="bi bi-lightning-charge-fill"></i>
                         </div>
                     </div>
                     <div class="ms-3">
                         <h6 class="fw-bold mb-1">Logistics</h6>
                         <p class="small text-muted mb-0 lh-sm">Route optim. saves <strong>$12k/mo</strong>.</p>
                     </div>
                 </div>

                 <div class="d-flex mb-4">
                     <div class="flex-shrink-0">
                         <div class="rounded-circle bg-white shadow-sm p-3 d-flex align-items-center justify-content-center text-danger" style="width:45px; height:45px;">
                             <i class="bi bi-shield-exclamation"></i>
                         </div>
                     </div>
                     <div class="ms-3">
                         <h6 class="fw-bold mb-1">Risk</h6>
                         <p class="small text-muted mb-0 lh-sm">Diversify "Category A" suppliers.</p>
                     </div>
                 </div>
                 
                 <div class="alert alert-info border-0 shadow-sm mb-0 p-2">
                     <small><i class="bi bi-info-circle-fill me-1"></i> Based on 45k points.</small>
                 </div>
             </div>
        </div>

        <!-- Inventory Dist (Span 2) -->
        <div class="card shadow-sm border-0 glass-panel span-col-2 animate-enter delay-6">
             <div class="card-body p-4">
                 <h5 class="fw-bold mb-4">Inventory Distribution</h5>
                 <div style="height: 300px;">
                     <canvas id="doughnutChart"></canvas>
                 </div>
             </div>
        </div>

        <!-- Supplier Risk (Span 2) -->
        <div class="card shadow-sm border-0 glass-panel span-col-2 animate-enter delay-6">
             <div class="card-body p-4">
                 <h5 class="fw-bold mb-4">Supplier Risk Analysis</h5>
                 <div style="height: 300px;">
                     <canvas id="polarChart"></canvas>
                 </div>
             </div>
        </div>

        <!-- Map (Span 4) -->
        <div class="card shadow-lg border-0 glass-panel span-col-4 animate-enter delay-7 overflow-hidden p-0">
            <div class="card-header bg-dark text-white border-bottom-0 py-3 px-4">
                 <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0"><i class="bi bi-globe2 text-info me-2"></i> Global Network Live Status</h5>
                    <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25"><i class="bi bi-circle-fill small me-1"></i> Operational</span>
                 </div>
            </div>
             <div class="card-body p-0">
                 <div id="map" style="height: 500px; width: 100%;"></div>
             </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const user = sessionManager.getCurrentUser();
        if (!user) return;

        // Executive Analytics is Strictly for Admins in Silsila Logic
        if (user.role !== 'admin') {
            notificationManager.showToast('Executive Analytics restricted to Administrators.', 'error');
            setTimeout(() => {
                if (user.role === 'customer') window.location.href = '/CustomerDashboard';
                else if (user.role === 'supplier') window.location.href = '/SupplierDashboard';
                else window.location.href = '/UserDashboard';
            }, 1500);
            return;
        }
    });

    // Protect this page
    if (!sessionManager.isLoggedIn()) {
        window.location.href = '/Login';
    }
</script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // Use ResizeObserver to fix Canvas Size Issues
        const ctx = document.getElementById('complexChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'],
                datasets: [
                    {
                        label: 'Revenue',
                        data: [4500, 5200, 6000, 5800, 7000, 7500],
                        backgroundColor: '#10b981',
                        borderRadius: 4,
                        order: 2
                    },
                    {
                        label: 'Profit',
                        data: [3000, 3500, 4000, 3800, 4800, 5200],
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        order: 3
                    },
                    {
                        type: 'line',
                        label: 'Growth',
                        data: [4800, 5500, 6200, 6000, 7200, 7800],
                        borderColor: '#f59e0b',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { font: { size: 14, family: 'Inter' } } } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Advanced Doughnut Chart
        new Chart(document.getElementById('doughnutChart'), {
            type: 'doughnut',
            data: {
                labels: ['Electronics', 'Furniture', 'Apparel', 'Parts'],
                datasets: [{
                    data: [35, 25, 20, 20],
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                cutout: '70%', 
                borderRadius: 20,
                spacing: 8,
                plugins: { legend: { position: 'right', labels: { font: { size: 14, family: 'Inter' }, usePointStyle: true } } }
            }
        });

        // Polar Area Chart
        new Chart(document.getElementById('polarChart'), {
            type: 'polarArea',
            data: {
                labels: ['Supplier A', 'Supplier B', 'Supplier C', 'Supplier D'],
                datasets: [{
                    data: [11, 16, 7, 14],
                    backgroundColor: ['rgba(99, 102, 241, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(245, 158, 11, 0.6)', 'rgba(239, 68, 68, 0.6)'],
                    borderWidth: 1
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { font: { size: 14, family: 'Inter' } } } },
                scales: { r: { ticks: { display: false }, grid: { circular: true } } }
            }
        });

        // Map
        var map = L.map('map').setView([30.0444, 31.2357], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        var locations = [
            { lat: 30.0444, lng: 31.2357, title: "Cairo HQ" },
            { lat: 40.7128, lng: -74.0060, title: "New York Hub" },
            { lat: 51.5074, lng: -0.1278, title: "London Depot" },
            { lat: 35.6895, lng: 139.6917, title: "Tokyo Branch" }
        ];

        locations.forEach(function(loc) {
            L.marker([loc.lat, loc.lng]).addTo(map).bindPopup('<b>' + loc.title + '</b><br>Status: Operational');
        });
        
        // Resize map on load to prevent rendering issues in hidden tabs/cards
        setTimeout(function(){ map.invalidateSize(); }, 500);
    </script>
}
